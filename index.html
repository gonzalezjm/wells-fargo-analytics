<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Wells Fargo Analytics Competition by gonzalezjm</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Wells Fargo Analytics Competition</h1>
        <p class="header">Fall 2015 Data Science</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/gonzalezjm/wells-fargo-analytics/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/gonzalezjm/wells-fargo-analytics/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/gonzalezjm/wells-fargo-analytics">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/gonzalezjm">gonzalezjm</a></p>


      </header>
      <section>
        <h2>
<a id="process-flow-diagram" class="anchor" href="#process-flow-diagram" aria-hidden="true"><span class="octicon octicon-link"></span></a>Process Flow Diagram</h2>

<p><img src="http://i.imgur.com/UBQ4LBQ.png" alt="Process-Diagram-img"></p>

<h2>
<a id="code" class="anchor" href="#code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Code</h2>

<div class="highlight highlight-source-r"><pre><span class="pl-v">df</span> <span class="pl-k">=</span> read.table(<span class="pl-s"><span class="pl-pds">'</span>dataset.txt<span class="pl-pds">'</span></span>,<span class="pl-v">sep</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span>,<span class="pl-v">header</span><span class="pl-k">=</span><span class="pl-c1">T</span>)
<span class="pl-c"># load('df.Rda')</span>
<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-v">FullText</span> <span class="pl-k">=</span> as.character(<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">FullText</span>)</pre></div>

<h2>
<a id="description" class="anchor" href="#description" aria-hidden="true"><span class="octicon octicon-link"></span></a>Description</h2>

<p>In order to attain a workable dataset, we import dataset.txt into a data frame, then clean the FullText column of non-ASCII characters, punctuation, and other “trouble” terms we might come across, such as words with no meaningful value in the context of the analysis. We then add a column to our data frame called “BankID”, which allows us to keep track of which bank each comment references.
The code to complete this is:</p>

<div class="highlight highlight-source-r"><pre><span class="pl-c"># loads the text file with the data and puts it into a data frame</span>
<span class="pl-v">df</span> <span class="pl-k">=</span> read.table(<span class="pl-s"><span class="pl-pds">'</span>dataset.txt<span class="pl-pds">'</span></span>,<span class="pl-v">sep</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>|<span class="pl-pds">"</span></span>,<span class="pl-v">header</span><span class="pl-k">=</span><span class="pl-c1">T</span>)

<span class="pl-c"># FullText: the column in the dataframe that contains the tweets/statuses</span>
<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-v">FullText</span> <span class="pl-k">=</span> as.character(<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">FullText</span>)

<span class="pl-c"># Grab just the texts, to load them into the Corpus</span>
<span class="pl-v">df.texts</span> <span class="pl-k">=</span> as.data.frame(<span class="pl-smi">df</span>[,ncol(<span class="pl-smi">df</span>)])
colnames(<span class="pl-smi">df.texts</span>) <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>FullText<span class="pl-pds">'</span></span>

<span class="pl-c"># Remove non-ascii characters</span>
<span class="pl-v">df.texts.clean</span> <span class="pl-k">=</span> as.data.frame(iconv(<span class="pl-smi">df.texts</span><span class="pl-k">$</span><span class="pl-smi">FullText</span>, <span class="pl-s"><span class="pl-pds">"</span>latin1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>ASCII<span class="pl-pds">"</span></span>, <span class="pl-v">sub</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>))
colnames(<span class="pl-smi">df.texts.clean</span>) <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>FullText<span class="pl-pds">'</span></span>

<span class="pl-c"># stores the new cleaned FullText into the data frame in place of the original FullText column</span>
<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-v">FullText</span> <span class="pl-k">=</span> <span class="pl-smi">df.texts.clean</span><span class="pl-k">$</span><span class="pl-smi">FullText</span>

<span class="pl-c"># If you want to test on just 10000 records using df.10000 created below (can be any # of records)</span>
<span class="pl-v">idx.10000</span> <span class="pl-k">=</span> sample(<span class="pl-c1">1</span><span class="pl-k">:</span>nrow(<span class="pl-smi">df</span>),<span class="pl-c1">10000</span>)
<span class="pl-v">df.10000</span> <span class="pl-k">=</span> <span class="pl-smi">df</span>[<span class="pl-smi">idx.10000</span>,]

<span class="pl-v">df.entire</span> <span class="pl-k">=</span> <span class="pl-smi">df</span>
<span class="pl-v">df</span> <span class="pl-k">=</span> <span class="pl-smi">df.10000</span>

<span class="pl-c"># Load using the tm library</span>
library(<span class="pl-smi">tm</span>) 
<span class="pl-smi">docs</span> <span class="pl-k">&lt;-</span> Corpus(DataframeSource(as.data.frame(<span class="pl-smi">df</span>[,<span class="pl-c1">6</span>])))  

<span class="pl-smi">docs</span> <span class="pl-k">&lt;-</span> tm_map(<span class="pl-smi">docs</span>, <span class="pl-smi">PlainTextDocument</span>)  

<span class="pl-c"># remove punctuation</span>
<span class="pl-smi">docs</span> <span class="pl-k">&lt;-</span> tm_map(<span class="pl-smi">docs</span>, <span class="pl-smi">removePunctuation</span>) 

<span class="pl-c"># Strip extra whitespace</span>
<span class="pl-smi">docs</span> <span class="pl-k">&lt;-</span> tm_map(<span class="pl-smi">docs</span>, <span class="pl-smi">stripWhitespace</span>)

<span class="pl-c">#Grab indexes of comments for different banks</span>
<span class="pl-v">bankA.idx</span> <span class="pl-k">=</span> which(sapply(<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">FullText</span>,<span class="pl-k">function</span>(<span class="pl-smi">x</span>) grepl(<span class="pl-s"><span class="pl-pds">"</span>BankA<span class="pl-pds">"</span></span>,<span class="pl-smi">x</span>)))
<span class="pl-v">bankB.idx</span> <span class="pl-k">=</span> which(sapply(<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">FullText</span>,<span class="pl-k">function</span>(<span class="pl-smi">x</span>) grepl(<span class="pl-s"><span class="pl-pds">"</span>BankB<span class="pl-pds">"</span></span>,<span class="pl-smi">x</span>)))
<span class="pl-v">bankC.idx</span> <span class="pl-k">=</span> which(sapply(<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">FullText</span>,<span class="pl-k">function</span>(<span class="pl-smi">x</span>) grepl(<span class="pl-s"><span class="pl-pds">"</span>BankC<span class="pl-pds">"</span></span>,<span class="pl-smi">x</span>)))
<span class="pl-v">bankD.idx</span> <span class="pl-k">=</span> which(sapply(<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">FullText</span>,<span class="pl-k">function</span>(<span class="pl-smi">x</span>) grepl(<span class="pl-s"><span class="pl-pds">"</span>BankD<span class="pl-pds">"</span></span>,<span class="pl-smi">x</span>)))

<span class="pl-c">#give each bank a name</span>
<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-v">BankID</span> <span class="pl-k">=</span> <span class="pl-c1">NaN</span><span class="pl-k">*</span><span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">MediaType</span> <span class="pl-c"># Only do this because I want it to be the right size</span>
<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">BankID</span>[<span class="pl-smi">bankA.idx</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>BankA<span class="pl-pds">"</span></span>
<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">BankID</span>[<span class="pl-smi">bankB.idx</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>BankB<span class="pl-pds">"</span></span>
<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">BankID</span>[<span class="pl-smi">bankC.idx</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>BankC<span class="pl-pds">"</span></span>
<span class="pl-smi">df</span><span class="pl-k">$</span><span class="pl-smi">BankID</span>[<span class="pl-smi">bankD.idx</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>BankD<span class="pl-pds">"</span></span>

<span class="pl-c">#put data into docs for each bank</span>
<span class="pl-v">bankA.docs</span> <span class="pl-k">=</span> <span class="pl-smi">docs</span>[<span class="pl-smi">bankA.idx</span>]
<span class="pl-v">bankB.docs</span> <span class="pl-k">=</span> <span class="pl-smi">docs</span>[<span class="pl-smi">bankB.idx</span>]
<span class="pl-v">bankC.docs</span> <span class="pl-k">=</span> <span class="pl-smi">docs</span>[<span class="pl-smi">bankC.idx</span>]
<span class="pl-v">bankD.docs</span> <span class="pl-k">=</span> <span class="pl-smi">docs</span>[<span class="pl-smi">bankD.idx</span>] 
</pre></div>

<p>Once we have the data properly loaded and sorted, we can start creating different plots/visuals. In our case, we ran word frequencies, word associations, and word cluster dendrograms. As we looked at different plots, I started removing terms that I thought were not useful from the data. Some terms were very stubborn and could not be removed from the data for some reason. This was a recurring problem throughout the project. Below is the exact list of words I decided to remove from the data.</p>

<div class="highlight highlight-source-r"><pre><span class="pl-smi">docs</span> <span class="pl-k">&lt;-</span> tm_map(<span class="pl-smi">docs</span>, <span class="pl-smi">removeWords</span>,c(<span class="pl-s"><span class="pl-pds">"</span>their<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>from<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>had<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>who<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>was<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>have<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>you<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>but<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>they<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>its<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>just<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>got<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>one<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>will<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>with<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>has<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>Name<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>nameresp<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>dirmsg<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>and<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>for<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>twithndl<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>let<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>this<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>are<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>what<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>would<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>here<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>nameresp<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>that<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>the<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>rettwit<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>https<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>http<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>twithndlbanka<span class="pl-pds">"</span></span>)) </pre></div>

<p>Once we had a set of words that we were content with, we found the frequent terms, created a word cloud and created a cluster dendrogram for the data as a whole. The code snippets below show how we were able to achieve that.</p>

<p>Finding frequent terms:</p>

<div class="highlight highlight-source-r"><pre><span class="pl-smi">tdm</span> <span class="pl-k">&lt;-</span> TermDocumentMatrix(<span class="pl-smi">docs</span>)
<span class="pl-smi">dtm</span> <span class="pl-k">&lt;-</span> DocumentTermMatrix(<span class="pl-smi">docs</span>)

findFreqTerms(<span class="pl-smi">dtm</span>,<span class="pl-c1">2000</span>)

<span class="pl-smi">freq</span> <span class="pl-k">&lt;-</span> colSums(as.matrix(<span class="pl-smi">dtm</span>))  
<span class="pl-smi">ord</span> <span class="pl-k">&lt;-</span> order(<span class="pl-smi">freq</span>)   
<span class="pl-smi">freq</span>[head(<span class="pl-smi">ord</span>)]  
<span class="pl-smi">freq</span>[tail(<span class="pl-smi">ord</span>)]
<span class="pl-smi">freq</span>[<span class="pl-smi">ord</span>[(length(<span class="pl-smi">ord</span>)<span class="pl-k">-</span><span class="pl-c1">100</span>)<span class="pl-k">:</span>length(<span class="pl-smi">ord</span>)]]

<span class="pl-v">dtm</span> <span class="pl-k">=</span> removeSparseTerms(<span class="pl-smi">dtm</span>, <span class="pl-c1">0.98</span>)</pre></div>

<p>Creating a word cloud:</p>

<div class="highlight highlight-source-r"><pre>library(<span class="pl-smi">wordcloud</span>)   
set.seed(<span class="pl-c1">142</span>)   
<span class="pl-smi">dark2</span> <span class="pl-k">&lt;-</span> brewer.pal(<span class="pl-c1">6</span>, <span class="pl-s"><span class="pl-pds">"</span>Dark2<span class="pl-pds">"</span></span>)  
wordcloud(names(<span class="pl-smi">freq</span>), <span class="pl-smi">freq</span>, <span class="pl-v">max.words</span><span class="pl-k">=</span><span class="pl-c1">100</span>, <span class="pl-v">rot.per</span><span class="pl-k">=</span><span class="pl-c1">0.2</span>, <span class="pl-v">colors</span><span class="pl-k">=</span><span class="pl-smi">dark2</span>) <span class="pl-c"># 100 most frequent words</span></pre></div>

<h2>
<a id="word-cloud" class="anchor" href="#word-cloud" aria-hidden="true"><span class="octicon octicon-link"></span></a>Word Cloud</h2>

<p><img src="http://i.imgur.com/29NPvyZ.png" alt="Word-Cloud-img"></p>

<p>Creating a cluster dendrogram:</p>

<div class="highlight highlight-source-r"><pre><span class="pl-smi">dtmss</span> <span class="pl-k">&lt;-</span> removeSparseTerms(<span class="pl-smi">dtm</span>, <span class="pl-c1">0.98</span>) 
<span class="pl-c">#inspect(dtmss)</span>

library(<span class="pl-smi">cluster</span>)   
<span class="pl-smi">d</span> <span class="pl-k">&lt;-</span> dist(t(<span class="pl-smi">dtmss</span>), <span class="pl-v">method</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>euclidian<span class="pl-pds">"</span></span>)   
<span class="pl-smi">fit</span> <span class="pl-k">&lt;-</span> hclust(<span class="pl-v">d</span><span class="pl-k">=</span><span class="pl-smi">d</span>, <span class="pl-v">method</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>ward.D<span class="pl-pds">"</span></span>)   

plot(<span class="pl-smi">fit</span>, <span class="pl-v">hang</span><span class="pl-k">=</span><span class="pl-k">-</span><span class="pl-c1">1</span>)  

<span class="pl-smi">groups</span> <span class="pl-k">&lt;-</span> cutree(<span class="pl-smi">fit</span>, <span class="pl-v">k</span><span class="pl-k">=</span><span class="pl-c1">5</span>)   <span class="pl-c"># "k=" defines the number of clusters you are using   </span>
rect.hclust(<span class="pl-smi">fit</span>, <span class="pl-v">k</span><span class="pl-k">=</span><span class="pl-c1">5</span>, <span class="pl-v">border</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>red<span class="pl-pds">"</span></span>) <span class="pl-c"># draw dendogram with red borders around the 5 clusters  </span></pre></div>

<h2>
<a id="cluster-dendrogram" class="anchor" href="#cluster-dendrogram" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cluster Dendrogram</h2>

<p><img src="http://i.imgur.com/U3k8IkR.png" alt="Cluster-Dendrogram-img"></p>

<div class="highlight highlight-source-r"><pre>findAssocs(<span class="pl-smi">dtmss</span>, c(<span class="pl-s"><span class="pl-pds">"</span>banka<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>bankb<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>bankc<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>bankd<span class="pl-pds">"</span></span>), <span class="pl-v">corlimit</span><span class="pl-k">=</span><span class="pl-c1">0.01</span>)

findAssocs(<span class="pl-smi">dtmss</span>, c(<span class="pl-s"><span class="pl-pds">"</span>credit<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>internet<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>business<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>account<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>financial<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>over<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>money<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>phone<span class="pl-pds">"</span></span>), <span class="pl-v">corlimit</span><span class="pl-k">=</span><span class="pl-c1">0.01</span>)

findAssocs(<span class="pl-smi">dtmss</span>, c(<span class="pl-s"><span class="pl-pds">"</span>rating<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>thank<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>card<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>time<span class="pl-pds">"</span></span>), <span class="pl-v">corlimit</span><span class="pl-k">=</span><span class="pl-c1">0.01</span>)</pre></div>

<p>Once we have our data properly sorted, we create five Document-Term Matrices and five Term-Document Matrices; one of each for the entire dataset, and one of each for each bank. Using the Document-Term matrices, we can analyze the frequencies at which each term appears in the dataset, in the entire dataset or within the context of a specific bank. This allows us to see the most commonly used words, and consequently, the most commonly referenced topics.</p>

<p>Each comment is scored on its “sentiment” by matching the terms in the comment to two libraries of “positive” and “negative” terms. Each score is found by subtracting the number of negative terms in the comment from the number of positive terms in the comment. We then use “very positive” (score &gt; 1) and “very negative” (score &lt; -1) scores to calculate the global score using the formula GlobalScore = 100 * verypos / (verypos + veryneg).</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
